<!DOCTYPE html>
<html>
	<head>
		<title>Résultat Élections Départementales 2015</title>
		<script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
		<script src="src/Label.js"></script>
		<script src="src/BaseMarkerMethods.js"></script>
		<script src="src/Marker.Label.js"></script>
		<script src="src/CircleMarker.Label.js"></script>
		<script src="src/Path.Label.js"></script>
		<script src="src/Map.Label.js"></script>
		<script src="src/FeatureGroup.Label.js"></script>
		<script src="bureaux.geojson"></script>
		<script src="decoupage.geojson"></script>
		<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
		<style>
        body {
            padding: 0;
            margin: 0;
			overflow:hidden;
        }
        html, body, #map {
            height: 100%;
            width: 100%;
        }
		.legende {
			position: absolute;
			right: 0;
			top: 0;
			margin: 0;
			padding: 1rem;
			width: 17rem;
			height: 100%;
			text-align: left;
			background: rgba(255,255,255,0.8);
			color: #333333;
			font-size: 12px;
		}
		
		#survolez {
			text-align: center;
			font-size: 14px;
		}
		
		.tour {
			position: absolute;
			top: 0;
			width: 100%;
			margin: auto;
			text-align: center;
		}
		
		.tour form {
			padding: 5px;
			display: inline-block;
			width: 12rem;
			text-align: center;
			background: rgba(255,255,255,0.8);
			font-weight: bold;
			font-size: 18px;
		}
		
		.pourcentage {
			display:inline-block;
			font-size:12px;
			font-weight:bold;
			margin:0;
			margin-left:5px;
			margin-bottom:5px;
		}
		
		.voix {
			display:inline-block;
			font-size:9px;
			margin:0;
			position:relative;
			bottom:0.5px;
		}
		
		h2 {
			text-align: center;
		}

		.leaflet-label-petit {
			color: #111;
			display: block;
			font: 8px "Helvetica Neue", Arial, Helvetica, sans-serif;
			font-weight: bold;
			position: absolute;
			z-index: 6;
			-webkit-user-select: none;
			   -moz-user-select: none;
				-ms-user-select: none;
					user-select: none;
		}
		
		.leaflet-label-grand {
			color: #111;
			display: block;
			font: 15px "Helvetica Neue", Arial, Helvetica, sans-serif;
			font-weight: bold;
			position: absolute;
			z-index: 6;
			-webkit-user-select: none;
			   -moz-user-select: none;
				-ms-user-select: none;
					user-select: none;
		}
		
		</style>
	</head>
	<body>
		<div id="map"></div>
		<div class="legende" id="legende"></div>
		<div class="tour">
			<form><input type='radio' name='tours' value='tour1' id='tour1' checked="checked">Tour 1 <input type='radio' name='tours' value='tour2' id='tour2'>Tour 2</form>
		</div>
		
		<script type="text/javascript">		
		
		// Variable à modifier :
		
			// [["nom du parti","nom du champs des resultats de ce parti (en nombre de voix)","couleur du parti"][...]]
			// Le geojson doit comporter un champs ins_1tr et ins_2tr avec le nombre d'inscrits sur les listes par bureau

		var tour1=[["Union de la Droite","UD_1tr",'#001eff'],
				["Front National","FN_1tr",'#020e40'],
				["Union de la Gauche","UG_1tr",'#ff7dc0'],
				["Front de Gauche","FG_1tr",'#d00000']];
				
		var tour2=[["Union de la Droite","UD_2tr",'#001eff'],
				["Front National","FN_2tr",'#020e40']];
		
		var nomElections="Départementales 2015";
		
		// Légende quand aucun périmètre n'est survolé
		
		function legendeGenerale() {
			html = "<h2>Résultat Élections "+ nomElections +"<br>Valenciennes</h2>";
			html+= "<br>";
			html+="<p id='survolez'><b><u>Survolez les différents zonages pour avoir le détail par bureau de vote</u></b></p>";
			
			if(document.getElementById('tour1').checked){
				//On calcule les totaux, on les range dans un array puis on les tri
				totalIns_1tr=0;
				zoneElec.eachLayer(function(layer){
						totalIns_1tr+=layer.feature.properties.ins_1tr;
					});
				totalTour1=[];
				tour1.forEach(function(a){
					totalPart=0;
					zoneElec.eachLayer(function(layer){
						totalPart+=layer.feature.properties[a[1]];
					});
					totalTour1.push([a[0],a[1],totalPart,a[2]]);
				});
				totalTour1.sort(function(a,b) {return a[2]-b[2]}).reverse();
				//Somme des voix exprimées
				totalExp=0;
				totalTour1.forEach(function(a){totalExp += a[2]});
				//Affichage des résultats
				html+="<b>Résultats du 1<SUP>er</SUP> tour pour l'ensemble de la commune : </b><br><br>";
				for (x in totalTour1){
					pourcentage=(totalTour1[x][2]/totalExp*100).toFixed(2);
					html+= totalTour1[x][0] + " : <p class='voix'>(" + totalTour1[x][2] + " voix)</p><br>" + "<li style='display:inline-block;width:"+ pourcentage + "%; background-color:"+totalTour1[x][3]+"; color:" +totalTour1[x][3]+"'>.</li><p class='pourcentage'> "+ pourcentage + " %</p><br>";
				};
				participation=(totalExp/totalIns_1tr*100).toFixed(2);
				abstention=100-participation;
				html+="<li style='display:inline-block;width:" + participation + "%; background-color:#a0a0a0;color:#a0a0a0;margin-top:35px'>.</li>";
				html+="<li style='display:inline-block;width:" + abstention + "%; background-color:#d2d2d2;color:#d2d2d2;margin-top:35px'>.</li>";
				html+="<br>Taux de participation : <p class='pourcentage'>"+ participation + " % </p> <p class='voix'>(" +totalExp+" voix/" +totalIns_1tr+" inscrits)</p>";
				
			}else if(document.getElementById('tour2').checked){
				//On calcule les totaux, on les range dans un array puis on les tri
				totalIns_2tr=0;
				zoneElec.eachLayer(function(layer){
						totalIns_2tr+=layer.feature.properties.ins_2tr;
					});
				totalTour2=[];
				tour2.forEach(function(a){
					totalPart=0;
					zoneElec.eachLayer(function(layer){
						totalPart+=layer.feature.properties[a[1]];
					});
					totalTour2.push([a[0],a[1],totalPart,a[2]]);
				});
				totalTour2.sort(function(a,b) {return a[2]-b[2]}).reverse();
				//Somme des voix exprimées
				totalExp=0;
				totalTour2.forEach(function(a){totalExp += a[2]});
				//Affichage des résultats
				html+="<b>Résultats du 2<SUP>er</SUP> tour pour l'ensemble de la commune : </b><br><br>";
				for (x in totalTour2){
					pourcentage=(totalTour2[x][2]/totalExp*100).toFixed(2);
					html+= totalTour2[x][0] + " : <p class='voix'>(" + totalTour2[x][2] + " voix)</p><br>" + "<li style='display:inline-block;width:"+ pourcentage + "%; background-color:"+totalTour2[x][3]+"; color:" +totalTour2[x][3]+"'>.</li><p class='pourcentage'> "+ pourcentage + " %</p><br>";
				};
				participation=(totalExp/totalIns_2tr*100).toFixed(2);
				abstention=100-participation;
				html+="<li style='display:inline-block;width:" + participation + "%; background-color:#a0a0a0;color:#a0a0a0;margin-top:35px'>.</li>";
				html+="<li style='display:inline-block;width:" + abstention + "%; background-color:#d2d2d2;color:#d2d2d2;margin-top:35px'>.</li>";
				html+="<br>Taux de participation : <p class='pourcentage'>"+ participation + " % </p> <p class='voix'>(" +totalExp+" voix/" +totalIns_2tr+" inscrits)</p>";
			};
			document.getElementById('legende').innerHTML = html;
		};
		
		
		// Fonction déclenchée quand on passe sur une feature :
		
		function highlightFeature(e) {
		
			// legende :
			
			html = "<h2>Résultat Élections "+ nomElections +"<br>Valenciennes</h2>";
			html+= "<br>";
			if(document.getElementById('tour1').checked){
				html+= "<b>Résultats du 1<SUP>er</SUP> tour au bureau de vote : <br><br>" + e.target.feature.properties.ID_BUREAU + " - " + e.target.feature.properties.DENOM_BURE + "</b><br><br>";		
				
				//On range les résultats dans un array puis on les tri
				tour1.sort(function(a,b) {
					return e.target.feature.properties[a[1]]-e.target.feature.properties[b[1]];
				}).reverse();
				//Somme des voix exprimées
				totalExp=0;
				tour1.forEach(function(a){totalExp += e.target.feature.properties[a[1]]});
				//Affichage des résultats
				for (x in tour1){
					pourcentage=(e.target.feature.properties[tour1[x][1]]/totalExp*100).toFixed(2);
					html+= tour1[x][0] + " : <p class='voix'>(" + e.target.feature.properties[tour1[x][1]] + " voix)</p><br>" + "<li style='display:inline-block;width:"+ pourcentage + "%; background-color:"+tour1[x][2]+"; color:" +tour1[x][2]+"'>.</li><p class='pourcentage'> "+ pourcentage + " %</p><br>";
				};
				participation=(totalExp/e.target.feature.properties.ins_1tr*100).toFixed(2);
				abstention=100-participation;
				html+="<li style='display:inline-block;width:" + participation + "%; background-color:#a0a0a0;color:#a0a0a0;margin-top:35px'>.</li>";
				html+="<li style='display:inline-block;width:" + abstention + "%; background-color:#d2d2d2;color:#d2d2d2;margin-top:35px'>.</li>";
				html+="<br>Taux de participation : <p class='pourcentage'>"+ participation + " % </p> <p class='voix'>(" +totalExp+" voix/" +e.target.feature.properties.ins_1tr+" inscrits)</p>";
			
			}else if(document.getElementById('tour2').checked){
				html+= "<b>Résultats du 2<SUP>ème</SUP> tour au bureau de vote : <br><br>" + e.target.feature.properties.ID_BUREAU + " - " + e.target.feature.properties.DENOM_BURE + "</b><br><br>";		
				
				//On range les résultats dans un array puis on les tri
				tour2.sort(function(a,b) {
					return e.target.feature.properties[a[1]]-e.target.feature.properties[b[1]];
				}).reverse();
				//Somme des voix exprimées
				totalExp=0;
				tour2.forEach(function(a){totalExp += e.target.feature.properties[a[1]]});
				//Affichage des résultats
				for (x in tour2){
					pourcentage=(e.target.feature.properties[tour2[x][1]]/totalExp*100).toFixed(2);
					html+= tour2[x][0] + " : <p class='voix'>(" + e.target.feature.properties[tour2[x][1]] + " voix)</p><br>" + "<li style='display:inline-block;width:"+ pourcentage + "%; background-color:"+tour2[x][2]+"; color:" +tour2[x][2]+"'>.</li><p class='pourcentage'> "+ pourcentage + " %</p><br>";
				};
				participation=(totalExp/e.target.feature.properties.ins_2tr*100).toFixed(2);
				abstention=100-participation;
				html+="<li style='display:inline-block;width:" + participation + "%; background-color:#a0a0a0;color:#a0a0a0;margin-top:35px'>.</li>";
				html+="<li style='display:inline-block;width:" + abstention + "%; background-color:#d2d2d2;color:#d2d2d2;margin-top:35px'>.</li>";
				html+="<br>Taux de participation : <p class='pourcentage'>"+ participation + " % </p> <p class='voix'>(" +totalExp+" voix/" +e.target.feature.properties.ins_2tr+" inscrits)</p>";
			};
			document.getElementById('legende').innerHTML = html;
			
			// style du feature :
			
			e.target.setStyle({weight: 4, fillOpacity: 0.9});
			
			// mise en valeur du bureau de vote :
			
			bureauSelect=e.target.feature.properties.ID_BUREAU;
			bureauOn=bureaux.getLayers()[bureauSelect-1];
			if (bureauSelect<10){
				bureauOn.updateLabelContent("<p style='font-size:15px;position:relative;right:3px;bottom:19px'>"+bureauSelect+"</p>");
			}else{
				bureauOn.updateLabelContent("<p style='font-size:15px;position:relative;right:4.5px;bottom:19px'>"+bureauSelect+"</p>");
			};
			bureauOn.setIcon(iconBureauSelect);
			bureauOn.setZIndexOffset(1000);
			bureauOn.setOpacity(1);
			
		};
		
		// Fonction déclenchée quand on quitte une feature :
		function resetHighlight(e) {
			legendeGenerale()
			e.target.setStyle(styleBase);
			bureauOn.updateLabelContent("<p style='font-size:8px;position:relative;right:0px;bottom:7px'>"+bureauSelect+"</p>");
			if (bureauSelect<10){
				bureauOn.setIcon(iconBureau_1chiffre);
			}else{
				bureauOn.setIcon(iconBureau_2chiffres);
			};
			bureauOn.setZIndexOffset(1000);
			bureauOn.setZIndexOffset(-1000);
			bureauOn.setOpacity(0.8);			
		};
		
		// Fonction choix de couleur des features
		
		function couleurFeature(feature, layer) {
			if(document.getElementById('tour1').checked){
				//On range les résultats dans un array puis on les tri
				tour1.sort(function(a,b) {return feature.properties[a[1]]-feature.properties[b[1]]}).reverse();
				//On donne une couleur selon le parti en tête
				layer.setStyle({fillColor: tour1[0][2]});
				
			} else if (document.getElementById('tour2').checked){
				//On range les résultats dans un array puis on les tri
				tour2.sort(function(a,b) {return feature.properties[a[1]]-feature.properties[b[1]]}).reverse();
				//On donne une couleur selon le parti en tête
				layer.setStyle({fillColor: tour2[0][2]});
			};
		};
		
		// Fontion déclenchée au clic sur un bouton radio :
		
		function changeTour(e){
			legendeGenerale();
			zoneElec.eachLayer(function(layer){
				feature=layer.feature;
				couleurFeature(feature,layer);
			});
		};
				
		// Fonctions bouclées pour chaque feature :
		
		function onEachFeature(feature, layer){
			layer.on({
				mouseover: highlightFeature,
				mouseout: resetHighlight
			});
			
			couleurFeature(feature, layer);
		};
		
		// objet carte
		
		var map = L.map('map').setView([50.363, 3.52], 14);
		
		// fond de plan (ici MapQuest)
		
		L.tileLayer('http://otile1.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.png').addTo(map);
		
		// Style des polygones
		
		var styleBase = {fillOpacity: 0.75,
			weight: 1,
			opacity: 1,
			color: 'black'
		};
		
		// Ajoute la couche des zones électorales à la carte
		
		var zoneElec = L.geoJson(decoupage,{
			onEachFeature: onEachFeature,
			style: styleBase
		}).addTo(map);
		
		// Markers bureau de vote
		
		var iconBureau_1chiffre = L.icon({
			iconUrl:'urne.svg',
			iconSize: [25,25],
			iconAnchor:  [12.5,12.5],
			labelAnchor: [-15,15]});
			
		var iconBureau_2chiffres = L.icon({
			iconUrl:'urne.svg',
			iconSize: [25,25],
			iconAnchor:  [12.5,12.5],
			labelAnchor: [-18,15]});
			
		var iconBureauSelect = L.icon({
			iconUrl:'urne_lueur.svg',
			iconSize: [60,60],
			iconAnchor:  [30,33],
			labelAnchor: [-100,12]});
			
						
		// Ajoute la couche des bureaux de vote à la carte
		
		var bureaux = L.geoJson(bureaux, {
			pointToLayer: function (feature, latlng){
				if(feature.properties.ID_BUREAU < 10){
					return L.marker(latlng,{icon: iconBureau_1chiffre,opacity:0.8,clickable:false}).bindLabel(feature.properties.ID_BUREAU.toString(), {noHide: true,className: "leaflet-label-petit"});
				} else {
					return L.marker(latlng,{icon: iconBureau_2chiffres,opacity:0.8,clickable:false}).bindLabel(feature.properties.ID_BUREAU.toString(), {noHide: true,className: "leaflet-label-petit"});
				};
			}}).addTo(map);
				
		// Listener sur les boutons radios
		
		document.getElementById("tour1").addEventListener("click",changeTour);
		document.getElementById("tour2").addEventListener("click",changeTour);
		
		// Balance la légende générale :
		
		legendeGenerale()
		</script>
    </body>
</html>